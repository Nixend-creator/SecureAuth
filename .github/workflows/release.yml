name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0   # full history for changelog extraction

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build
        run: ./gradlew shadowJar --no-daemon

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract changelog for this release
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          # Extract section between "## [X.Y.Z]" and the next "## [" heading
          awk "/^## \[$VERSION\]/{found=1; next} found && /^## \[/{exit} found{print}" CHANGELOG.md > RELEASE_NOTES.md
          # If section is empty fall back to a default message
          if [ ! -s RELEASE_NOTES.md ]; then
            echo "See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for full details." > RELEASE_NOTES.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: SecureAuth v${{ steps.version.outputs.VERSION }}
          body_path: RELEASE_NOTES.md
          files: build/libs/SecureAuth-${{ steps.version.outputs.VERSION }}.jar
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
